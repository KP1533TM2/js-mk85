<!DOCTYPE html>
<html>
<head>
<script src="cpu/cpu_common.js" type="text/javascript" encoding="UTF-8"></script>
<script src="cpu/cpu_definitions.js" type="text/javascript" encoding="UTF-8"></script>
<script src="cpu/cpu_interrupts.js" type="text/javascript" encoding="UTF-8"></script>
<script src="cpu/cpu_exec_branches.js" type="text/javascript" encoding="UTF-8"></script>
<script src="cpu/cpu_exec_jumps.js" type="text/javascript" encoding="UTF-8"></script>
<script src="cpu/cpu_exec_doubleops.js" type="text/javascript" encoding="UTF-8"></script>
<script src="cpu/cpu_exec_singleops.js" type="text/javascript" encoding="UTF-8"></script>
<script src="cpu/cpu_exec_onehalfops.js" type="text/javascript" encoding="UTF-8"></script>
<script src="cpu/cpu_exec_misc.js" type="text/javascript" encoding="UTF-8"></script>
<script src="cpu/cpu_exec_condcode.js" type="text/javascript" encoding="UTF-8"></script>
<script src="cpu/cpu_addressing.js" type="text/javascript" encoding="UTF-8"></script>
<script src="cpu/cpu_flags.js" type="text/javascript" encoding="UTF-8"></script>
<script src="cpu/cpu_decoder.js" type="text/javascript" encoding="UTF-8"></script>
<script src="svg/svg_display.js" type="text/javascript" encoding="UTF-8"></script>
</head>
<meta charset="UTF-8">
<body>

<h1>MK85 CPU Debug</h1>

<button type="button" onclick="frameCallback()"> CPU step </button></br>
<button type="button" onclick="cpu.reset()"> Reset </button></br>

<p id="regs">regs</p><br>

<script>

var cpuflags = [
	["H",0x0100],
	["I",0x0080],
	["T",0x0010],
	["N",0x0008],
	["Z",0x0004],
	["V",0x0002],
	["C",0x0001]];

function cpustep(){
	cpu.step();
	updateRegs();
}

function updateRegs() {
	regs = document.getElementById("regs");
	regstr = "";
	for(var i = 0; i<8; i++)
	{
		regstr += "R";
		regstr += i.toString(10);
		regstr += " = " + cpu.reg_u16[i].toString(16);
		regstr += "\n";
	}
	regstr += "PSW: ";
	for(var j = 0; j < cpuflags.length; j++) {
		regstr += (cpu.psw&cpuflags[j][1])?(cpuflags[j][0]):"-";
	}
	regs.innerHTML="<pre>"+regstr+"</pre>";

}

var ram = new Uint8Array(2048);

var ramBuf = new ArrayBuffer(2048);
var ram_u8 = new Uint8Array(ramBuf);
var ram_u16 = new Uint16Array(ramBuf);	// useful for in-browser debugging


for(var i = 0; i < 2048; i++) {
	ram_u8[i]=(Math.floor(Math.random()*255));
};

var rom;

var lcd = MK85_SVG_LCD();
lcd.timerCallback = frameCallback;
document.body.appendChild(lcd.svg);

var cpu = new CPU();

cpu.readCallback = function (addr) {
	return (addr&0x8000)?ram_u8[addr&0x07FF]:rom[addr&0x7FFF];
};

cpu.writeCallback = function (addr, byteVal) {
	if((addr>0x7f)&&(addr<0xe0)) {	// 0x80...0xDF is LCD contoller memory
		lcd.videoMemory[addr&0x7f] = byteVal;
		return;
	}
	if(addr==0xe0) {			// 0xe0 - LCD cursor register
		lcd.cursorReg = byteVal;
		return;
	}
	if(addr&0x8000) {
		ram_u8[addr&0x7FFF] = byteVal;
		return;
	}
};

function timerFunction() {
	var video = [];
	for (var i = 0; i < 96; i++) { video.push(ram_u8[i]); }
	//
	lcd.redraw(video); //redrawSimpleDisplay();
}


var oReq = new XMLHttpRequest();
oReq.open("GET", "/rom.bin", true);
oReq.responseType = "arraybuffer";

oReq.onload = function (oEvent) {
	var arrayBuffer = oReq.response; // Note: not oReq.responseText
	if (arrayBuffer) {
		rom = new Uint8Array(arrayBuffer);
		console.log("ROM loaded");
	};
	cpu.reg_u16[7] = 0x1006;	// jump directly to TEST routine
	cpu.nextFun = cpu.execCode;
	lcd.animate(10);
};
oReq.send(null);

function frameCallback() {
	if(lcd.timerHandle==null) cpu.step();
	for(var x = 0; (x < 150)&&(lcd.timerHandle != null); x++)
	{
		cpu.step();
		if(cpu.reg_u16[7] == /*0xa88*/ 0)
		{
			lcd.stopAnimating(); // breakpoint!
			break;
		}
	}
	updateRegs();
};

function doFrame(){
	cpustep();
	timerFunction();

};






</script>

</body>
</html> 
