<!DOCTYPE html>
<html>
<head>
<script src="cpu/cpu_common.js" type="text/javascript" encoding="UTF-8"></script>
<script src="cpu/cpu_definitions.js" type="text/javascript" encoding="UTF-8"></script>
<script src="cpu/cpu_interrupts.js" type="text/javascript" encoding="UTF-8"></script>
<script src="cpu/cpu_exec_branches.js" type="text/javascript" encoding="UTF-8"></script>
<script src="cpu/cpu_exec_jumps.js" type="text/javascript" encoding="UTF-8"></script>
<script src="cpu/cpu_exec_doubleops.js" type="text/javascript" encoding="UTF-8"></script>
<script src="cpu/cpu_exec_singleops.js" type="text/javascript" encoding="UTF-8"></script>
<script src="cpu/cpu_exec_onehalfops.js" type="text/javascript" encoding="UTF-8"></script>
<script src="cpu/cpu_exec_misc.js" type="text/javascript" encoding="UTF-8"></script>
<script src="cpu/cpu_exec_condcode.js" type="text/javascript" encoding="UTF-8"></script>
<script src="cpu/cpu_addressing.js" type="text/javascript" encoding="UTF-8"></script>
<script src="cpu/cpu_flags.js" type="text/javascript" encoding="UTF-8"></script>
<script src="cpu/cpu_decoder.js" type="text/javascript" encoding="UTF-8"></script>
<script src="mk85display.js" type="text/javascript" encoding="UTF-8"></script>

</head>
<meta charset="UTF-8">
<body>

<h1>MK85 CPU Debug</h1>

<button type="button" onclick="cpustep()"> CPU step </button></br>
<button type="button" onclick="cpu.reset()"> Reset </button></br> 

<button type="button" onclick="scratchmonkey()"> thingamajig </button></br>

<p id="regs">regs</p><br>

<script>

var cpuflags = [
	["H",0x0100],
	["I",0x0080],
	["T",0x0010],
	["N",0x0008],
	["Z",0x0004],
	["V",0x0002],
	["C",0x0001]];

function cpustep(){
	cpu.step();
	regs = document.getElementById("regs");
	regstr = "";
	for(var i = 0; i<8; i++)
	{
		regstr += "R";
		regstr += i.toString(10);
		regstr += " = " + cpu.reg_u16[i].toString(16);
		regstr += "\n";
	};
	regstr += "PSW: ";
	for(var j = 0; j < cpuflags.length; j++) {
		regstr += (cpu.psw&cpuflags[j][1])?(cpuflags[j][0]):"-";
	};
	regs.innerHTML="<pre>"+regstr+"</pre>";
}

var ram = new Uint8Array(65536);

function loadWords( x ) {
	for(var startAddr in x) {
		console.log("Writing words at", startAddr.toString(16));
		var addr = startAddr;
		var words = x[startAddr];
		for(var i = 0; i < words.length; i++) {
			ram[addr++] = words[i]&0xff;
			ram[addr++] = (words[i]>>8)&0xff;
		}
	}
};

var test = {
	0x0000:	[0x8000, 0x0500],
	0x8000: [0x95c0, 0x000f, 0x0c40, 0x00c0, 0x01fd]
};

loadWords(test);

/* create CPU object */
cpu = new CPU();

console.log(cpu.step);

/* bind it to RAM */
cpu.readCallback = function (addr) {
	return ram[addr];
};

cpu.writeCallback = function (addr, byteVal) {
	ram[addr] = byteVal;
};

/* we just read the 1st instruction */
cpu.reg_u16[7] = 0x0002;

function scratchmonkey() {
	console.log(cpu.makeDC0(0));
}

console.log("hOi!");
</script>
</body>
</html>
