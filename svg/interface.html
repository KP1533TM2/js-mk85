<!DOCTYPE html>
<html>
<head>
<script src="/cpu/cpu_common.js" type="text/javascript" encoding="UTF-8"></script>
<script src="/cpu/cpu_definitions.js" type="text/javascript" encoding="UTF-8"></script>
<script src="/cpu/cpu_interrupts.js" type="text/javascript" encoding="UTF-8"></script>
<script src="/cpu/cpu_exec_branches.js" type="text/javascript" encoding="UTF-8"></script>
<script src="/cpu/cpu_exec_jumps.js" type="text/javascript" encoding="UTF-8"></script>
<script src="/cpu/cpu_exec_doubleops.js" type="text/javascript" encoding="UTF-8"></script>
<script src="/cpu/cpu_exec_singleops.js" type="text/javascript" encoding="UTF-8"></script>
<script src="/cpu/cpu_exec_onehalfops.js" type="text/javascript" encoding="UTF-8"></script>
<script src="/cpu/cpu_exec_misc.js" type="text/javascript" encoding="UTF-8"></script>
<script src="/cpu/cpu_exec_condcode.js" type="text/javascript" encoding="UTF-8"></script>
<script src="/cpu/cpu_addressing.js" type="text/javascript" encoding="UTF-8"></script>
<script src="/cpu/cpu_flags.js" type="text/javascript" encoding="UTF-8"></script>
<script src="/cpu/cpu_decoder.js" type="text/javascript" encoding="UTF-8"></script>
<script src="/svg/svg_display.js" type="text/javascript" encoding="UTF-8"></script>
<script src="/svg/svg_face.js" type="text/javascript" encoding="UTF-8"></script>
<script src="/svg/svg_face_keys.js" type="text/javascript" encoding="UTF-8"></script>
<script src="/svg/entrypoint.js" type="text/javascript" encoding="UTF-8"></script>
</head>
<meta charset="UTF-8">
<body>

<h1>MK-85, yay!</h1>
<p id="regs"></p><br>

<div id="mk85"></div>

<div id="debugger">
<button type="button" onclick="runStuff()">Run</button>
<button type="button" onclick="step()">Step</button>
<button type="button" onclick="addBreakpoint()">Breakpoint add</button>
Breakpoint addr (hex):
<input id="breakpointAddr"></input>
<br>
Memory offset
<input id="memoryOffset"></input>
<button type="button" onclick="applyOffset()">Apply</button>
<button type="button" onclick="switchMemView(true)">Word view</button>
<button type="button" onclick="switchMemView(false)">Byte view</button>
<br>
<p id="mem" style="font-family:monospace">uuuuh herro</p>
</div>

<script>

var memOffset = 0x8000;
var memWords = false;

var svgNS = "http://www.w3.org/2000/svg";
var mk85 = new MK85(document.getElementById("mk85"));
mk85.initializeDefault();


function toHex(val, pad) {
	var s = val.toString(16);
	console.log(val, s);
	while(s.length<pad) s = "0" + s;
	return s;
}

function switchMemView(words) {
	memWords = words;
	updateMemView();
}

function updateMemView() {
	// show a bit of memory
	var rows = 20;
	var bytesPerRow = 16;
	var addr = memOffset;
	console.log("addr? ", memOffset); 
	var p = "";
	for(var x = 0; x< rows; x++) {
		// print address
		var line = toHex(addr,4)+": ";
		var tmp = 0;
		
		var byteCounter = bytesPerRow;
		while(byteCounter--) {
			if(memWords)
			{
				if(addr&1) addr++;
				else line += toHex(mk85.cpu.access(addr++, null, false), 4) + " ";
			} else {
				line += toHex(mk85.cpu.access(addr++, null, true), 2) + " ";
			}
		}
		
		p += line + "\n";
		
	}
	document.getElementById('mem').innerHTML = "<pre>"+p+"</pre>";
}

function applyOffset() {
	memOffset = parseInt(document.getElementById('memoryOffset').value, 16);
	updateMemView();	
}

function addBreakpoint() {
	console.log("asdf");
	mk85.addBreakpoint(parseInt(document.getElementById('breakpointAddr').value, 16));
}

function runStuff() {
	mk85.breakpointHit = false;
	mk85.gui.lcd.animate(10);
}

function step() {
	mk85.breakpointHit = true;
	mk85.gui.lcd.doFrame();
	updateRegs();
	updateMemView();
}

var cpuflags = [
	["H",0x0100],
	["I",0x0080],
	["T",0x0010],
	["N",0x0008],
	["Z",0x0004],
	["V",0x0002],
	["C",0x0001]];
	
function updateRegs() {
	regs = document.getElementById("regs");
	regstr = "";
	var cpu = mk85.cpu;
	for(var i = 0; i<8; i++)
	{
		regstr += "R";
		regstr += i.toString(10);
		regstr += " = " + cpu.reg_u16[i].toString(16);
		regstr += "\n";
	}
	regstr += "PSW: ";
	for(var j = 0; j < cpuflags.length; j++) {
		regstr += (cpu.psw&cpuflags[j][1])?(cpuflags[j][0]):"-";
	}
	regstr += " "+cpu.psw.toString(16);
	regs.innerHTML="<pre>"+regstr+"</pre>";

}


</script>

</body>
</html> 
